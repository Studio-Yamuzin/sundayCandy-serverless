# NOTE: update this with your service name
service: sundaycandy-serverless

# Create an optimized package for our functions
package:
  excludeDevDependencies: false
  include:
    - node_modules/**

plugins:
  - serverless-bundle # Package our functions with Webpack
  - serverless-offline
  - serverless-dotenv-plugin # Load .env as environment variables
  - serverless-appsync-plugin

provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: ap-northeast-2
  environment:
    devCognitoUserPoolId: ap-northeast-2_eOsy1c65x
    tableName: ${env:TABLE_NAME}
    authTableName: ${env:AUTH_TABLE_NAME}

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
        - cognito-idp:AdminDeleteUser
        - cognito-idp:AdminUpdateUserAttributes
        - cognito-idp:AdminGetUser
        - cognito-idp:ListUsers
      Resource:
        - "arn:aws:cognito-idp:ap-northeast-2:674304001403:userpool/*"
        - "arn:aws:dynamodb:ap-northeast-2:*:*"
custom:
  bundle:
    linting: false # Enable linting as a part of the build process
    tsConfig: "tsconfig.json" # Path to your 'tsconfig.json', if it's not in the root
    aliases: # Create an alias to 'import' modules easily with a custom path
      - src: src
    packager: yarn
  appSync:
    authenticationType: AMAZON_COGNITO_USER_POOLS
    userPoolConfig:
      awsRegion: ap-northeast-2
      defaultAction: ALLOW
      userPoolId: ap-northeast-2_eOsy1c65x
      existing: true
    name: sundayCandy-graphql
    schema:
      - schemas/Profile.graphql
      - schemas/Church.graphql
      - schemas/Bible.graphql
    mappingTemplatesLocation: resolvers
    mappingTemplates:
      - type: Mutation
        field: createProfile
        dataSource: sundayCandy
      - type: Mutation
        field: updateProfile
        dataSource: sundayCandy
      - type: Mutation
        field: createChurch
        dataSource: sundayCandy
      - type: Query
        field: getBibleByChapter
        dataSource: sundayCandy
      - type: Query
        field: getBibleByPhrase
        dataSource: sundayCandy
      - type: Query
        field: getBibleByVerse
        dataSource: sundayCandy
      - type: Query
        field: getChurch
        dataSource: sundayCandy
      - type: Query
        field: getProfile
        dataSource: sundayCandy
    dataSources:
      - type: AMAZON_DYNAMODB
        name: sundayCandy
        description: sundayCandy Table
        config:
          tableName: sundayCandy
          iamRoleStatements:
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:Query
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:DeleteItem
                - dynamodb:DescribeTable
              Resource: "arn:aws:dynamodb:ap-northeast-2:*:*"
functions:
  kakao:
    handler: src/auth/kakaoSignUp.main
    events:
      - http:
          path: kakao/signUp
          method: post
  preSignUp:
    handler: src/auth/preSignUp.main
    events:
      - http:
          path: preSignUp
          method: post
  preKakaoAuthentication:
    handler: src/auth/preKakaoAuthentication.main
    events:
      - http:
          path: preKakaoAuthentication
          method: post